---
title: "Cloze Project Data Analysis"
output: html_notebook
---

Load our packages
```{r}
knitr::opts_chunk$set(echo = TRUE)
suppressPackageStartupMessages(library(Rmisc))
suppressPackageStartupMessages(library(data.table))
suppressPackageStartupMessages(library(stringr))
suppressPackageStartupMessages(library(dplyr))
suppressPackageStartupMessages(library(ggplot2))
suppressPackageStartupMessages(library(ez))
suppressPackageStartupMessages(library(lme4))
suppressPackageStartupMessages(library(gridExtra))

```

Load and summarize the data. We also want to switch the data types of 
ClausePlacement and Location to categorical since they are just binary factors

```{r}
data <- read.csv('../data/PreprocessedData.csv')
data$ClausePlacement <- as.factor(data$ClausePlacement)
data$Location <- as.factor(data$Location)
summary(data)
```
Since we are interested in the cloze probability of the target word in each 
Item + Condition, we need to an additional column ResponseIsTarget, which 
indicates whether the participants gave Target or not.
```{r}
data <- data %>%
  mutate(ResponseIsTarget = Response == Target)
summary(data)
```

Setting up our contrasts (is this right? lol)
```{r}
contrasts.Tri <- 
  matrix(c(1/2, 1/2,
           -1, 1), 
         ncol = 2) %>%
  t(.) %>%
  solve(.) %>%
  .[,2:2]

contrasts(data$ClausePlacement) <- contrasts.Tri
contrasts(data$Location) <- c(-.5,.5)

model_matrix <- model.matrix( ~ ClausePlacement * Location, data)

data$cp1 <- model_matrix[,2]
data$l1 <- model_matrix[,3]
summary(data)
```
GLM model
This one didn't converge with the maximal model. Therefore, interactions were 
removed from the random effects.
```{r}
g_model <- glmer(ResponseIsTarget ~ 1 + cp1 * l1 +
                (1 + cp1 + l1|| Participant) + 
                (1 + cp1 + l1|| Item), 
              data=data, 
              family = 'poisson',
              na.action = na.omit)
summary(g_model)
```

Since we are interested in the cloze probability in each condition, we need to 
calculate that, too. For this, we'll create a new dataframe called grouped_data 
because crucially, we are grouping all of our data by Item and Condition. 
Notably, this means we won't have random effects by Subject, only by Item.
grouped_data has the following columns
Item: the item number
cp1: the encoded clause placement level
l1: the encoded location level
Cloze Prob: the cloze probability of the target word for each item and condition
```{r}
grouped_data <- data %>% 
  group_by(Item, cp1, l1) %>%
  summarise(ClozeProb = sum(ResponseIsTarget) / length(ResponseIsTarget), 
            .groups = 'keep')
summary(grouped_data)
```
Now we are ready to create our model. As mentioned before, we won't have any
random effects by Subject, only by Item. With that restriction, we'll opt for
the maximal model.
```{r} 
lm_model1 <- lmer(ClozeProb ~ 1 + cp1 * l1 +
                   (1 + cp1 + l1 + cp1 * l1 || Item),
                 REML=FALSE, 
                 data = grouped_data,
                 control = lmerControl(calc.derivs=FALSE), 
                 na.action = na.omit
                 )
summary(lm_model1)
```
