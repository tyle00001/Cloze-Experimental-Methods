---
title: "Cloze Project Data Analysis"
output: html_notebook
---
```{r setup, include=FALSE}

```

```{r}
knitr::opts_chunk$set(echo = TRUE)
suppressPackageStartupMessages(library(Rmisc))
suppressPackageStartupMessages(library(data.table))
suppressPackageStartupMessages(library(stringr))
suppressPackageStartupMessages(library(dplyr))
suppressPackageStartupMessages(library(ggplot2))
suppressPackageStartupMessages(library(lme4))
suppressPackageStartupMessages(library(gridExtra))
suppressPackageStartupMessages(library(tidyr))
suppressPackageStartupMessages(library(optimx))
suppressPackageStartupMessages(library(car))
```

```{r}
data <- read.csv('../data/PreprocessedData.csv')
data$ClausePlacement <- as.factor(data$ClausePlacement)
data$Location <- as.factor(data$Location)
summary(data)
```
Load and summarize the data. We also want to switch the data types of 
ClausePlacement and Location to categorical since they are just binary factors

```{r}
data <- data %>%
  mutate(Target = case_when(
    Location == 'Original' ~ Target,
    Location == 'Replacement' ~ NA
  )) %>%
  fill(Target, .direction='down')

data <- data %>%
  mutate(ResponseIsTarget = Response == Target)
summary(data)
```
Since we are interested in the cloze probability of the target word in each 
Item + Condition, we need to an additional column ResponseIsTarget, which 
indicates whether the participants gave Target or not.

```{r}
contrasts.Tri <- 
  matrix(c(1/2, 1/2,
           -1, 1), 
         ncol = 2) %>%
  t(.) %>%
  solve(.) %>%
  .[,2:2]

contrasts(data$ClausePlacement) <- contrasts.Tri
contrasts(data$Location) <- c(-.5,.5)

model_matrix <- model.matrix( ~ ClausePlacement * Location, data)

data$cp1 <- model_matrix[,2]
data$l1 <- model_matrix[,3]
summary(data)
```
Setting up our contrasts

```{r}
grouped_data <- data %>% 
  group_by(Item, cp1, l1) %>%
  summarise(ClozeProb = sum(ResponseIsTarget) / length(ResponseIsTarget),
            )
summary(grouped_data)
```
Since we are interested in the cloze probability in each condition, we need to 
calculate that, too. For this, we'll create a new dataframe called grouped_data 
because crucially, we are grouping all of our data by Item and Condition. 
Notably, this means we won't have random effects by Subject, only by Item.
grouped_data has the following columns
Item: the item number
cp1: the encoded clause placement level
l1: the encoded location level
Cloze Prob: the cloze probability of the target word for each item and condition

```{r}
mod <- aov(ClozeProb ~ cp1 * l1,
  data = grouped_data
)
shapiro.test(mod$residuals)
```
Our data is not normally distributed per the Shapiro-Wild test, barring us from
using LM or ANOVA. 

```{r} 
lm_model1 <- lmer(ClozeProb ~ 1 + cp1 * l1 +
                   (1 + cp1 + l1 + cp1 * l1 || Item),
                 REML=FALSE, 
                 data = grouped_data,
                 control = lmerControl(calc.derivs=FALSE), 
                 na.action = na.omit
                 )
summary(lm_model1) # one with the interaction in the random effects
```
LMM model
Now we are ready to create our models As mentioned before, we won't have any
random effects by Subject, only by Item. 
In short, we observe a significant main effect for location. However, let's 
create another model.
```{r}
grouped_data$res <- residuals(lm_model1)
model1_res <- lmer(res ~ 1 + cp1 * l1 +
                   (1 + cp1 + l1 + cp1 * l1 || Item),
                  REML=FALSE, 
                  data = grouped_data,
                  control = lmerControl(calc.derivs=FALSE), 
                  na.action = na.omit)
summary(rePCA(model1_res))
                  
```
As we can see, almost all variance is accounted for by the third component, so 
we can do some model reduction.
```{r}
VarCorr(model1_res) 
```
It looks like the the intercept by Item is basically useless.
```{r}
lm_model2 <- lmer(ClozeProb ~ 1 + cp1 * l1 +
                   (0 + cp1 + l1 + cp1 * l1 || Item),
                 REML=FALSE, 
                 data = grouped_data,
                 control = lmerControl(calc.derivs=FALSE), 
                 na.action = na.omit
                 )
summary(lm_model2)
```
We create a new model and repeat the process.
```{r}
grouped_data$res <- residuals(lm_model2)
model2_res <- lmer(res ~ 1 + cp1 * l1 +
                   (0 + cp1 + l1 + cp1 * l1 || Item),
                  REML=FALSE, 
                  data = grouped_data,
                  control = lmerControl(calc.derivs=FALSE), 
                  na.action = na.omit)
summary(rePCA(model2_res))
```
Looks better!
```{r}
VarCorr(model2_res)
```
This looks like a good place to stop. lm_model2 is now our final model.

-------------------
```{r}
g_model <- glmer(ResponseIsTarget ~ 1 + cp1 * l1 +
                (1 + cp1 + l1 + cp1 * l1|| Participant) + 
                (1 + cp1 + l1 + cp1 * l1|| Item), 
              data=data, 
              control = glmerControl(
                optimizer ='optimx', 
                optCtrl=list(method='L-BFGS-B')),
              family = 'poisson',
              na.action = na.omit)
summary(g_model)
```

An alternative: GLMM
Here, our response variable is just ResponseIsTarget, a binary variable. We can
use random effects by Subject since we aren't grouping our data by Item and 
Condition as with the LMM. 
Once again, we only observe a significant main effect of Location.

```{r}
grouped_data.SE <- summarySE(
  data = grouped_data, 
  measurevar = 'ClozeProb',
  groupvars = c('cp1','l1'))

grouped_data.SE = grouped_data.SE %>%
  mutate(Location = case_when(
    l1 == -0.5 ~ 'Original',
    l1 == 0.5 ~ 'Replacement',
  )) %>%
  mutate(ClausePlacement = case_when(
    cp1 == -0.5 ~ 'Leading',
    cp1 == 0.5 ~ 'Intervening'
  ))

# first, a bar chart
ggplot(grouped_data.SE, aes(x = Location,y = ClozeProb,fill=Location)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = c('#00A36C','#BBA53D')) +
  labs(title = 'Cloze Probability of Target by Clause Placement and Condition',
       y = ' Cloze Probability of Target'
  ) +
  theme(plot.title = element_text(hjust = 0.5), legend.position="none") + 
  facet_grid(~ClausePlacement) + 
  geom_errorbar(aes(ymin = ClozeProb - se, ymax = ClozeProb + se), 
                width = 0.1, 
                size = 0.5)

ggplot(grouped_data.SE, 
       aes(x = Location, 
           y = ClozeProb, 
           group=ClausePlacement, 
           color = ClausePlacement)
       ) +
  geom_line() +
  geom_point() + 
  scale_color_manual(values = c('#00A36C','#BBA53D'),name = 'Clause Placement') +
  labs(title = 'Cloze Probability of Target by Clause Placement and Condition',
       y = ' Cloze Probability of Target'
  ) +
  geom_errorbar(aes(ymin = ClozeProb - se, ymax = ClozeProb + se), 
                width = 0.1, 
                size = 0.5)
  
```